<?php
// Secure include
include '../connect.php';

// Check if admin is logged in
if (isset($_COOKIE['admin_id'])) {
    $admin_id = $_COOKIE['admin_id'];
} else {
    $admin_id = '';
    header('location: login.php');
    exit;
}
if(isset($_POST['delete_product'])){

   $delete_id = $_POST['product_id'];
   $delete_id = filter_var($delete_id, FILTER_SANITIZE_STRING);

   $verify_delete = $conn->prepare("SELECT * FROM `products` WHERE id = ?");
   $verify_delete->execute([$delete_id]);

   if($verify_delete->rowCount() > 0){
      $select_images = $conn->prepare("SELECT * FROM `products` WHERE id = ?");
      $select_images->execute([$delete_id]);
      while($fetch_images = $select_images->fetch(PDO::FETCH_ASSOC)){
         $image_01 = $fetch_images['image_01'];
         $image_02 = $fetch_images['image_02'];
         $image_03 = $fetch_images['image_03'];
         if(!empty($image_01)){
            unlink('uploaded_files/'.$image_01);
         }
         if(!empty($image_02)){
            unlink('uploaded_files/'.$image_02);
         }
         if(!empty($image_03)){
            unlink('uploaded_files/'.$image_03);
         }
      }
      $delete_saved = $conn->prepare("DELETE FROM `saved` WHERE product_id = ?");
      $delete_saved->execute([$delete_id]);
      $delete_requests = $conn->prepare("DELETE FROM `requests` WHERE product_id = ?");
      $delete_requests->execute([$delete_id]);
      $delete_listing = $conn->prepare("DELETE FROM `products` WHERE id = ?");
      $delete_listing->execute([$delete_id]);
      $success_msg[] = 'Product deleted successfully!';
   }else{
      $warning_msg[] = 'Product already deleted!';
   }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Lighten Up - Admin My Products</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="author" content="Gemlyte IT Solutions">
  <meta name="keywords" content="Lighten Up, Gemlyte, Sample Project">
  <meta name="description" content="Gemlyte Sample Project">

  <!-- Favicon -->
  <link rel="shortcut icon" href="../image/logo/title.png" type="image/x-icon">

  <!-- Bootstrap Icons & CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Swiper -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" type="text/css" href="../css/loader.css">
  <link rel="stylesheet" type="text/css" href="../css/home-banner.css">
  <link rel="stylesheet" type="text/css" href="../css/home-product.css">
  <link rel="stylesheet" type="text/css" href="../css/home-about.css">
  <link rel="stylesheet" type="text/css" href="../css/home-contact.css">
  <link rel="stylesheet" type="text/css" href="../css/home-categories.css">
  <link rel="stylesheet" type="text/css" href="../css/home-view-product.css">
  <link rel="stylesheet" type="text/css" href="../css/style.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Open+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Karla:wght@300;400;500;600;700&family=Spectral:wght@400;500;600;700;800&display=swap" rel="stylesheet">

</head>
<body>
    <?php include __DIR__ . '/../components/admin_navbar.php'; ?>
    <!-- mr-products section start here -->
    <section class="my-product">
        <h1>My Products</h1>
        <form action="" method="POST">
            <input type="text" name="search_box" placeholder="Search product...">
            <button type="submit" name="search_btn" class="btn btn-dark rounded-circle"><i class="bi bi-search"></i></button>
        </form>
        <div class="container">
            <?php
                if(isset($_POST['search_box']) OR isset($_POST['search_btn'])){
                    $search_box=$_POST['search_box'];
                    $search_box=filter_var($search_box,FILTER_SANITIZE_STRING);
                    $select_products=$conn->prepare("SELECT * FROM `products` WHERE name LIKE '%{$search_box}%' or address LIKE '%{$search_box}%' ORDER BY date DESC");
                    $select_products->execute();
                }else{
                    $select_products=$conn->prepare("SELECT * FROM `products` WHERE name LIKE '%{$search_box}%' ORDER BY date DESC");
                    $select_products->execute();
                }
                if($select_products->rowCount()>0){
                    while($fetch_product=$select_products->fetch(PDO::FETCH_ASSOC)){
                        $product_id=$fetch_product['id'];
                        $select_users=$conn->prepare("SELECT * FROM `users` WHERE id=?");
                        $select_users->execute([$fetch_product['user_id']]);
                        $fetch_user=$select_users->fetch(PDO::FETCH_ASSOC);

                        if(!empty($fetch_product['image_02'])){
                            $image_02_count=1;
                        }else{
                            $image_02_count=0;
                        }

                        if(!empty($fetch_product['image_03'])){
                            $image_03_count=1;
                        }else{
                            $image_03_count=0;
                        }

                        $total_images=(1+$image_02_count+$image_03_count);
            ?>
            <div class="row">
                <div class="col-md-6 col-lg-4 col-xl-3">
                <form action="" method="POST" class="h-100">
                    <input type="hidden" name="product_id" value="<?= $product_id; ?>">

                    <div class="card shadow-lg h-100 border-0 rounded-3 product-card-hover">
                    <div class="position-relative">
                        <img src="uploaded_files/<?= $fetch_product['image_01']; ?>" 
                            class="card-img-top rounded-top" 
                            alt="<?= $fetch_product['product_name']; ?>" 
                            style="height: 220px; object-fit: cover;">
                        
                        <!-- Price Badge -->
                        <span class="badge bg-dark position-absolute top-0 start-0 m-2 px-3 py-2 fs-6 shadow">
                        â‚¹<?= $fetch_product['product_price']; ?>
                        </span>
                    </div>

                    <div class="card-body d-flex flex-column">
                        <!-- Title -->
                        <h5 class="card-title fw-bold text-dark text-truncate">
                        <?= $fetch_product['product_name']; ?>
                        </h5>

                        <!-- Meta info -->
                        <p class="mb-1 text-muted small"><i class="bi bi-tags"></i> Brand: <?= $fetch_product['product_brand']; ?></p>
                        <p class="mb-1 text-muted small"><i class="bi bi-box"></i> Material: <?= $fetch_product['product_material']; ?></p>
                        <p class="mb-3 text-muted small"><i class="bi bi-building"></i> Manufacturer: <?= $fetch_product['product_manufacturer']; ?></p>

                        <!-- Buttons -->
                        <div class="mt-auto">
                        <div class="d-flex gap-2">
                            <a href="update_product.php?get_id=<?= $product_id; ?>" 
                            class="btn btn-outline-primary btn-sm w-100">
                            <i class="bi bi-pencil-square me-1"></i> Update
                            </a>
                            <button type="submit" name="delete_product" 
                            class="btn btn-outline-danger btn-sm w-100"
                            onclick="return confirm('Are you sure you want to delete this product?');">
                            <i class="bi bi-trash me-1"></i> Delete
                            </button>
                        </div>
                        <a href="view_products.php?get_id=<?= $product_id; ?>" 
                            class="btn btn-dark btn-sm mt-3 w-100">
                            <i class="bi bi-eye me-1"></i> View Product
                        </a>
                        </div>
                    </div>
                    </div>
                </form>
                </div>
            </div>

            </form>
            <?php
                    }
                }elseif(isset($_POST['search_box']) OR isset($_POST['search_btn'])){
                    echo '<div class="col-12"><h4 class="alert alert-secondary text-center shadow-sm">No products available!</h4></div>';
                }else{
                    echo '<div class="col-12"><h4 class="alert alert-secondary text-center shadow-sm">No products added yet!</h4></div>';
                }
            ?>
        </div>
    </section>
    <!-- mr-products section end here -->
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <script src="../js/script.js"></script>
    <!-- Scripts -->
      <!-- Scripts -->
    <?php
    include '../components/message.php';
    ?>
    </body>
</html>
